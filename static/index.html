<!DOCTYPE html>
<!--
 Copyright (c) 2025 BillChen

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Claude Remote</title>
  <!-- DNS 预解析和预连接 CDN -->
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="stylesheet" href="/static/styles.css?v=63">
  <!-- xterm.js -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
</head>
<body>
  <!-- 登录视图 -->
  <div id="login-view" class="view active">
    <div class="login-container">
      <div class="login-card">
        <div class="login-logo">C</div>
        <h1 class="login-title">Claude Remote</h1>
        <p class="login-subtitle" data-i18n="login.subtitle">请输入访问令牌</p>
        <form id="login-form" class="login-form">
          <input
            type="password"
            id="login-token"
            class="login-input"
            data-i18n-placeholder="login.placeholder"
            placeholder="访问令牌"
            autocomplete="current-password"
            required
          >
          <div id="login-error" class="login-error"></div>
          <button type="submit" id="login-btn" class="btn btn-primary btn-block" data-i18n="login.button">
            登录
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- 会话列表视图 -->
  <div id="sessions-view" class="view">
    <header class="header">
      <div class="header-title" onclick="window.app && window.app.toggleDebugPanel()">
        <div class="system-info">
          <span class="system-user-host"><span id="system-username">--</span>@<span id="system-hostname" class="hostname">--</span></span>
          <span id="system-ip" class="system-ip">--</span>
        </div>
      </div>
      <div class="header-actions">
        <button id="usage-toggle-btn" class="btn-usage" data-i18n-title="sessions.usage">≡</button>
        <button id="create-session" class="btn-add">+</button>
        <button id="transfer-btn" class="btn-transfer" data-i18n-title="sessions.transfer">⇅</button>
        <button id="settings-btn" class="btn-settings" data-i18n-title="sessions.settings">⚙︎</button>
        <button id="sessions-help-btn" class="btn-help" data-i18n-title="sessions.help">?</button>
      </div>
    </header>

    <!-- 帮助面板 -->
    <div id="sessions-help-panel" class="help-panel sessions-help-panel">
      <div class="help-content">
        <div class="help-header">
          <span data-i18n="sessions.help.title">使用说明</span>
          <button id="sessions-help-close">✕</button>
        </div>
        <div class="help-list">
          <div class="help-item"><span class="help-key">≡</span><span data-i18n="sessions.help.usage">查看用量统计</span></div>
          <div class="help-item"><span class="help-key">↓</span><span data-i18n="sessions.help.pull">轻拉刷新 / 重拉刷新页面</span></div>
          <div class="help-item"><span class="help-key">✎ ✕</span><span data-i18n="sessions.help.cardButtons">重命名 / 删除会话</span></div>
          <div class="help-item"><span class="help-key">▤</span><span data-i18n="sessions.help.history">查看终端历史</span></div>
        </div>
        <div class="help-section-title" data-i18n="sessions.help.contextTitle">Context 图标说明</div>
        <div class="help-list help-list-icons">
          <div class="help-item"><span class="help-key help-key-purple">⛁</span><span data-i18n="sessions.help.ctxUsed">已用 / 最大容量 (%)</span></div>
          <div class="help-item"><span class="help-key help-key-gray">⛶</span><span data-i18n="sessions.help.ctxFree">剩余可用空间</span></div>
          <div class="help-item"><span class="help-key help-key-gray">⛝</span><span data-i18n="sessions.help.ctxCompact">距离自动压缩</span></div>
          <div class="help-item"><span class="help-key help-key-green">⚡</span><span data-i18n="sessions.help.ctxTotal">会话总消耗</span></div>
        </div>
        <div class="help-section-title" data-i18n="sessions.help.transferTitle">传输功能</div>
        <div class="help-list">
          <div class="help-item"><span class="help-key">⇅</span><span data-i18n="sessions.help.transfer">上传/下载文件</span></div>
        </div>
        <div class="help-tips">
          <div class="help-tip">💡 <span data-i18n="sessions.help.tip">点击左上角可查看调试日志</span></div>
        </div>
      </div>
    </div>

    <!-- 用量统计抽屉 -->
    <div id="usage-drawer" class="usage-drawer">
      <div class="usage-drawer-content">
        <!-- 用户信息 -->
        <div class="drawer-section user-profile">
          <div class="profile-header">
            <span id="profile-name" class="profile-name">--</span>
            <span id="profile-plan" class="profile-plan">--</span>
          </div>
          <div class="profile-footer">
            <span id="profile-email" class="profile-email">--</span>
            <span class="profile-stats">
              <span id="active-connections" class="stat-num">0</span><span data-i18n="usage.connections">连接</span> · <span id="active-terminals" class="stat-num">0</span><span data-i18n="usage.terminals">终端</span>
            </span>
          </div>
        </div>

        <!-- 用量进度条 -->
        <div class="drawer-section usage-bars">
          <!-- 5小时周期 -->
          <div class="usage-bar-item">
            <div class="usage-bar-header">
              <span class="usage-bar-label" data-i18n="usage.fiveHour">5小时周期</span>
              <span id="usage-5h-percent" class="usage-bar-percent">--%</span>
            </div>
            <div class="usage-progress-bar">
              <div id="usage-5h-progress" class="usage-progress" style="width: 0%"></div>
            </div>
            <div id="usage-5h-reset" class="usage-bar-reset">--</div>
          </div>

          <!-- 7天周期 -->
          <div class="usage-bar-item">
            <div class="usage-bar-header">
              <span class="usage-bar-label" data-i18n="usage.sevenDay">7天周期</span>
              <span id="usage-7d-percent" class="usage-bar-percent">--%</span>
            </div>
            <div class="usage-progress-bar">
              <div id="usage-7d-progress" class="usage-progress" style="width: 0%"></div>
            </div>
            <div id="usage-7d-reset" class="usage-bar-reset">--</div>
          </div>

          <!-- Sonnet 专用 -->
          <div class="usage-bar-item" id="usage-sonnet-section">
            <div class="usage-bar-header">
              <span class="usage-bar-label">Sonnet</span>
              <span id="usage-sonnet-percent" class="usage-bar-percent">--%</span>
            </div>
            <div class="usage-progress-bar">
              <div id="usage-sonnet-progress" class="usage-progress" style="width: 0%"></div>
            </div>
            <div id="usage-sonnet-reset" class="usage-bar-reset">--</div>
          </div>
        </div>

      </div>
    </div>

    <!-- 传输模态框 -->
    <div id="transfer-modal" class="modal">
      <div class="modal-content modal-small">
        <div class="modal-header">
          <div class="modal-header-left"></div>
          <h2 data-i18n="sessions.transfer">传输</h2>
          <div class="modal-header-right">
            <button id="transfer-modal-close" class="btn-close">&times;</button>
          </div>
        </div>
        <div class="modal-body">
          <div class="settings-menu">
            <div class="settings-menu-item" id="menu-upload-quick">
              <span data-i18n="transfer.upload">上传文件</span>
              <span class="settings-menu-arrow">^</span>
            </div>
            <div class="settings-menu-item" id="menu-download-quick">
              <span data-i18n="transfer.download">下载文件</span>
              <span class="settings-menu-arrow">v</span>
            </div>
            <div class="settings-menu-item" id="menu-upload-history-quick">
              <span data-i18n="transfer.uploadHistory">上传历史</span>
              <span class="settings-menu-arrow">›</span>
            </div>
            <div class="settings-menu-item" id="menu-download-history-quick">
              <span data-i18n="transfer.downloadHistory">下载历史</span>
              <span class="settings-menu-arrow">›</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <main class="main" id="sessions-main">
      <!-- 左右滑动容器 -->
      <div class="swipe-container" id="swipe-container">
        <!-- 第一屏: 项目列表 -->
        <div class="swipe-page" id="page-projects">
          <!-- 下拉刷新指示器 -->
          <div id="pull-refresh" class="pull-refresh">
            <div class="pull-refresh-spinner"></div>
            <span class="pull-refresh-text" data-i18n="sessions.pullToRefresh">下拉刷新</span>
          </div>
          <div id="sessions-list" class="sessions-list">
            <div class="loading" data-i18n="sessions.loading">加载中...</div>
          </div>
        </div>
        <!-- 第二屏: 所有会话网格 -->
        <div class="swipe-page" id="page-all-sessions">
          <!-- 下拉刷新指示器 -->
          <div id="pull-refresh-sessions" class="pull-refresh">
            <div class="pull-refresh-spinner"></div>
            <span class="pull-refresh-text" data-i18n="sessions.pullToRefresh">下拉刷新</span>
          </div>
          <div id="all-sessions-grid" class="all-sessions-grid">
            <div class="loading" data-i18n="sessions.loading">加载中...</div>
          </div>
        </div>
      </div>
      <!-- 页面指示器 -->
      <div class="page-indicator" id="page-indicator">
        <span class="page-dot active" data-page="0"></span>
        <span class="page-dot" data-page="1"></span>
      </div>
    </main>
  </div>

  <!-- 创建会话模态框 -->
  <div id="create-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title">新建会话</h2>
        <button id="modal-close" class="btn-close">&times;</button>
      </div>
      <div class="modal-body">
        <!-- 步骤1: 选择工作目录 -->
        <div id="step-workdir" class="step active">
          <div class="step-title">选择工作目录</div>
          <!-- 历史目录 -->
          <div id="history-dirs" class="history-dirs">
            <div class="section-label">历史目录</div>
            <div id="workdir-list" class="workdir-list">
              <div class="loading">加载中...</div>
            </div>
          </div>
          <!-- 目录浏览器 -->
          <div class="dir-browser">
            <div class="section-label">浏览目录</div>
            <div class="current-path">
              <button id="go-parent" class="btn btn-icon">↑</button>
              <span id="current-path-text">~</span>
              <button id="select-current" class="btn btn-primary">选择</button>
            </div>
            <div id="dir-list" class="dir-list">
              <div class="loading">加载中...</div>
            </div>
          </div>
        </div>
        <!-- 步骤2: 选择 Claude 会话 -->
        <div id="step-session" class="step">
          <div class="step-title">选择 Claude 会话</div>
          <div class="selected-workdir">
            <span id="selected-workdir-text"></span>
            <button id="change-workdir" class="btn btn-text">更改</button>
          </div>
          <div id="claude-sessions" class="claude-sessions">
            <div class="loading">加载中...</div>
          </div>
          <button id="create-new-session" class="btn btn-primary btn-block">新建会话</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 设置模态框 -->
  <div id="settings-modal" class="modal">
    <div class="modal-content modal-small">
      <div class="modal-header">
        <div class="modal-header-left">
          <button id="settings-back-btn" class="btn-back-small hidden">←</button>
        </div>
        <h2 id="settings-modal-title" data-i18n="sessions.settings">设置</h2>
        <div class="modal-header-right">
          <button id="settings-modal-close" class="btn-close">&times;</button>
        </div>
      </div>
      <div class="modal-body">
        <!-- 主菜单 -->
        <div id="settings-menu" class="settings-menu">
          <div class="settings-menu-item" id="menu-language">
            <span data-i18n="settings.language">语言</span>
            <div class="settings-menu-right">
              <span class="settings-menu-value" id="current-lang-display">中文</span>
              <span class="settings-menu-arrow">›</span>
            </div>
          </div>
          <div class="settings-menu-item" id="menu-password">
            <span data-i18n="settings.title">修改密码</span>
            <span class="settings-menu-arrow">›</span>
          </div>
          <div class="settings-menu-item settings-menu-danger" id="menu-logout">
            <span data-i18n="settings.logout">退出登录</span>
          </div>
        </div>
        <!-- 隐藏的文件输入 -->
        <input type="file" id="file-input" style="display:none">

        <!-- 语言设置页 (动态生成) -->
        <div id="settings-language" class="settings-page"></div>

        <!-- 修改密码页 -->
        <div id="settings-password" class="settings-page">
          <form id="change-password-form" class="settings-form">
            <div class="form-group">
              <label data-i18n="settings.oldPassword">旧密码</label>
              <input type="password" id="old-password" class="form-input" required>
            </div>
            <div class="form-group">
              <label data-i18n="settings.newPassword">新密码</label>
              <input type="password" id="new-password" class="form-input" data-i18n-placeholder="settings.newPasswordHint" placeholder="至少6位" required>
            </div>
            <div class="form-group">
              <label data-i18n="settings.confirmPassword">确认新密码</label>
              <input type="password" id="confirm-password" class="form-input" required>
            </div>
            <div id="password-error" class="form-error"></div>
            <button type="submit" id="change-password-btn" class="btn btn-primary btn-block" data-i18n="settings.confirm">
              确认修改
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- 终端视图 -->
  <div id="terminal-view" class="view">
    <!-- 工具栏 -->
    <header class="toolbar">
      <button id="back-btn" class="btn-toolbar" data-i18n-title="terminal.close" title="关闭">←</button>
      <button id="minimize-btn" class="btn-toolbar" data-i18n-title="terminal.minimize" title="收起">⌄</button>
      <div class="toolbar-center" onclick="window.app && window.app.toggleDebugPanel()">
        <span id="connection-dot" class="connection-dot"></span>
        <span id="terminal-title" class="terminal-title">终端</span>
        <span id="connection-status" class="connection-status"></span>
      </div>
      <div class="toolbar-right">
        <button id="terminal-history-btn" class="btn-toolbar" data-i18n-title="terminal.historyBtn" title="历史">▤</button>
        <button id="help-btn" class="btn-help" onclick="window.app && window.app.toggleHelpPanel(event)">?</button>
      </div>
    </header>

    <!-- 悬浮字体控制 + 主题 + Context 按钮 -->
    <div class="font-controls-float">
      <button id="font-decrease" class="btn-font">A-</button>
      <button id="font-increase" class="btn-font">A+</button>
      <button id="theme-toggle" class="btn-font btn-theme" title="Theme">◐</button>
      <button id="context-toggle" class="btn-font btn-context" title="Context Info">⛁</button>
    </div>

    <!-- Context 信息悬浮条（默认收起） -->
    <div id="context-bar" class="context-bar collapsed" onclick="window.app && window.app.refreshContextInfo()">
      <!-- 内容由 JS 动态生成 -->
    </div>

    <!-- 帮助面板 -->
    <div id="help-panel" class="help-panel">
      <div class="help-content">
        <div class="help-header">
          <span data-i18n="terminal.help.title">按键说明</span>
          <button onclick="window.app && window.app.toggleHelpPanel(event)">✕</button>
        </div>
        <div class="help-section-title" data-i18n="terminal.help.keysTitle">快捷键</div>
        <div class="help-color-legend">
          <span class="legend-item legend-nav" data-i18n="terminal.help.nav">导航</span>
          <span class="legend-item legend-danger" data-i18n="terminal.help.danger">中断</span>
          <span class="legend-item legend-action" data-i18n="terminal.help.action">确认</span>
        </div>
        <div class="help-list">
          <div class="help-item"><span class="help-key help-key-nav">↑↓</span><span data-i18n="terminal.help.history">历史命令</span></div>
          <div class="help-item"><span class="help-key help-key-nav">⤒⤓</span><span data-i18n="terminal.help.scroll">滚动（长按连续）</span></div>
          <div class="help-item"><span class="help-key help-key-danger">ESC</span><span data-i18n="terminal.help.stop">停止操作</span></div>
          <div class="help-item"><span class="help-key help-key-action">TAB</span><span data-i18n="terminal.help.complete">自动补全</span></div>
          <div class="help-item"><span class="help-key help-key-action">↵</span><span data-i18n="terminal.help.send">发送</span></div>
        </div>
        <div class="help-section-title" data-i18n="terminal.help.floatTitle">悬浮按钮</div>
        <div class="help-list">
          <div class="help-item"><span class="help-key">A+A-</span><span data-i18n="terminal.help.fontSize">字体缩放</span></div>
          <div class="help-item"><span class="help-key">◐</span><span data-i18n="terminal.help.theme">切换终端主题</span></div>
          <div class="help-item"><span class="help-key help-key-purple">⛁</span><span data-i18n="terminal.help.context">Context 信息（点击刷新并滚底）</span></div>
          <div class="help-item"><span class="help-key help-key-nav">❷</span><span data-i18n="terminal.help.switchSession">切换会话 / 长按选择</span></div>
          <div class="help-item"><span class="help-key">▤</span><span data-i18n="terminal.help.historyBtn">终端历史（滚动加载/下拉刷新）</span></div>
        </div>
        <div class="help-tips">
          <div class="help-tip">💡 <span data-i18n="terminal.help.tip">点击 ⋯ 展开组合键和斜杠命令</span></div>
          <div class="help-tip">💡 <span data-i18n="terminal.help.tipDebug">点击标题查看调试日志</span></div>
          <div class="help-tip">💡 <span data-i18n="terminal.help.tipFont">输出排版混乱？试试调整字体大小</span></div>
        </div>
      </div>
    </div>

    <!-- 终端输出区域 -->
    <div id="terminal-output" class="terminal-container"></div>

    <!-- 底部输入栏（常驻） -->
    <div class="bottom-input-bar">
      <!-- 展开的更多按键面板 -->
      <div id="more-keys-panel" class="more-keys-panel">
        <div class="more-keys-section">
          <div class="more-keys-label" data-i18n="terminal.keys.combo">组合键</div>
          <div class="more-keys-row">
            <button class="key-btn key-edit" data-key="ctrl-l">^L <span data-i18n="terminal.keys.clear">清屏</span></button>
            <button class="key-btn key-edit" data-key="ctrl-o">^O <span data-i18n="terminal.keys.verbose">详细</span></button>
            <button class="key-btn key-nav" data-key="ctrl-b">^B <span data-i18n="terminal.keys.background">后台</span></button>
            <button class="key-btn key-danger" data-key="esc-esc">ESC×2 <span data-i18n="terminal.keys.rollback">回滚</span></button>
            <button class="key-btn key-nav" data-key="shift-tab">⇧Tab <span data-i18n="terminal.keys.mode">模式</span></button>
          </div>
        </div>
        <div class="more-keys-section">
          <div class="more-keys-label" data-i18n="terminal.keys.slash">斜杠命令</div>
          <div class="more-keys-row">
            <button class="key-btn key-action" data-key="cmd-resume">/resume</button>
            <button class="key-btn key-action" data-key="cmd-clear">/clear</button>
            <button class="key-btn key-action" data-key="cmd-help">/help</button>
            <button class="key-btn key-action" data-key="cmd-memory">/memory</button>
            <button class="key-btn key-action" data-key="cmd-compact">/compact</button>
          </div>
        </div>
      </div>
      <!-- 主按键行 -->
      <div class="special-keys">
        <button class="key-btn key-action" data-key="tab">TAB</button>
        <button class="key-btn key-nav" data-key="up">↑</button>
        <button class="key-btn key-nav" data-key="down">↓</button>
        <button class="key-btn key-danger" data-key="escape">ESC</button>
        <button class="key-btn key-edit" data-key="backspace">⌫</button>
        <button class="key-btn key-nav" data-key="top">⤒</button>
        <button class="key-btn key-nav" data-key="bottom">⤓</button>
        <button class="key-btn key-action" data-key="enter">↵</button>
        <button class="key-btn key-more" id="more-keys-btn">⋯</button>
      </div>
      <div class="input-row" id="input-row">
        <!-- input 动态创建 -->
        <button id="send-btn" class="btn btn-primary" data-i18n="terminal.send">发送</button>
      </div>
    </div>
  </div>

  <!-- 全局错误捕获 -->
  <script>
    window.onerror = function(msg, url, line, col, error) {
      alert('JS Error: ' + msg + ' at ' + url + ':' + line);
      return false;
    };
    window.addEventListener('unhandledrejection', function(event) {
      alert('Promise Error: ' + event.reason);
    });
  </script>
  <!-- 引入应用脚本 (defer: 并行加载，按顺序执行) -->
  <!-- MessagePack 二进制协议 -->
  <!-- SortableJS 拖拽排序 -->
  <script defer src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/@msgpack/msgpack@3.0.0-beta2/dist.es5+umd/msgpack.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/xterm-addon-webgl@0.16.0/lib/xterm-addon-webgl.js"></script>
  <script defer src="/static/terminal.js?v=12"></script>
  <script defer src="/static/session-manager.js?v=8"></script>
  <script defer src="/static/floating-button.js"></script>
  <script defer src="/static/i18n.js?v=16"></script>
  <!-- App 模块 -->
  <script defer src="/static/utils.js?v=3"></script>
  <script defer src="/static/debug.js?v=3"></script>
  <script defer src="/static/dialogs.js?v=23"></script>
  <script defer src="/static/settings.js?v=5"></script>
  <script defer src="/static/swipe.js?v=16"></script>
  <script defer src="/static/projects.js?v=24"></script>
  <script defer src="/static/websocket.js?v=43"></script>
  <script defer src="/static/upload.js?v=4"></script>
  <script defer src="/static/download.js?v=3"></script>
  <script defer src="/static/history.js?v=11"></script>
  <script defer src="/static/app.js?v=20"></script>
</body>
</html>
